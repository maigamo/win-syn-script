# Git 多项目自动同步脚本说明文档

## 目录结构

```
git_workspace/                          # 一级目录（名称任意）
├── auto-sys-test.ps1                   # 单项目同步脚本
├── multi-project-sync.ps1              # 多项目同步脚本
├── setup-multi-task.ps1                # Windows 计划任务管理脚本
├── projects-config.json                # 项目配置文件
├── build.log                           # 构建日志（自动生成）
└── multi-sync.log                      # 多项目同步日志（自动生成）
```

## 脚本说明

### 1. `auto-sys-test.ps1` - 单项目同步脚本

**功能：** 监控单个 Git 仓库更新，自动拉取代码、安装依赖、复制构建文件。

**使用方法：**
```powershell
# 使用当前分支
.\auto-sys-test.ps1

# 指定分支
.\auto-sys-test.ps1 -Branch "test"
.\auto-sys-test.ps1 -Branch "main"
```

**执行流程：**
1. 切换到项目目录
2. 检查远程仓库更新（git fetch）
3. 比较本地和远程版本
4. 如有更新则拉取代码（git pull / git reset --hard）
5. 安装 npm 依赖
6. 复制构建目录到目标位置

---

### 2. `multi-project-sync.ps1` - 多项目同步脚本

**功能：** 读取 `projects-config.json` 配置，批量同步多个 Git 项目。

**使用方法：**
```powershell
# 同步所有已启用的项目
.\multi-project-sync.ps1

# 只同步指定项目
.\multi-project-sync.ps1 -ProjectName "mc-shop-app"

# 列出所有配置的项目
.\multi-project-sync.ps1 -ListProjects
```

**参数说明：**
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-ConfigFile` | 配置文件路径 | 脚本目录下的 `projects-config.json` |
| `-ProjectName` | 只同步指定名称的项目 | 空（同步所有） |
| `-ListProjects` | 列出所有配置的项目 | `$false` |

---

### 3. `setup-multi-task.ps1` - 计划任务管理脚本

**功能：** 创建/管理 Windows 计划任务，实现定时自动同步。

**⚠️ 注意：需要以管理员身份运行**

**使用方法：**
```powershell
# 创建计划任务（每天 9:00-01:00，每小时执行一次）
.\setup-multi-task.ps1 -TaskAction create

# 查看任务状态
.\setup-multi-task.ps1 -TaskAction status

# 立即运行任务
.\setup-multi-task.ps1 -TaskAction run

# 停止运行中的任务
.\setup-multi-task.ps1 -TaskAction stop

# 删除计划任务
.\setup-multi-task.ps1 -TaskAction remove
```

**参数说明：**
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-TaskAction` | 操作类型：`create`, `remove`, `status`, `stop`, `run` | `create` |
| `-TaskName` | 任务名称 | `AutoMultiProjectSync` |

**计划任务时间表：**
- 每天 9:00 至次日 01:00
- 每小时执行一次
- 共 17 个触发点

---

### 4. `projects-config.json` - 项目配置文件

**配置示例：**
```json
{
    "description": "Multi-project sync configuration",
    "projects": [
        {
            "name": "mc-after-sales-app",
            "enabled": true,
            "projectDir": "F:\\workspace\\git_workspace\\mc-after-sales-app\\service-app",
            "targetDir": "F:\\workspace\\delivery\\MiniProgram_Tester\\after-sale-project\\mp-weixin",
            "branch": "test"
        },
        {
            "name": "mc-shop-app",
            "enabled": true,
            "projectDir": "F:\\workspace\\git_workspace\\mc-shop-app\\shop-app",
            "targetDir": "F:\\workspace\\delivery\\MiniProgram_Tester\\shop-app-project\\mp-weixin",
            "branch": "test"
        }
    ]
}
```

**字段说明：**
| 字段 | 类型 | 说明 |
|------|------|------|
| `name` | string | 项目名称（用于显示和指定同步） |
| `enabled` | boolean | 是否启用该项目的同步 |
| `projectDir` | string | Git 项目目录路径 |
| `targetDir` | string | 构建文件复制的目标目录 |
| `branch` | string | 要同步的分支名称 |

---

## Git 项目目录位置说明

**Git 项目可以放在任意目录**，不必放在脚本所在的二级目录下。只需在 `projects-config.json` 中正确配置 `projectDir` 的完整路径即可。

**示例配置：**
```json
{
    "projectDir": "D:\\projects\\my-app",           // 放在 D 盘
    "projectDir": "C:\\Users\\Admin\\git\\app",     // 放在用户目录
    "projectDir": "F:\\workspace\\git_workspace\\app" // 放在工作目录
}
```

---

## Git 免密码配置（GitLab Personal Access Token）

为了让脚本能够自动同步而无需输入密码，需要为每个 Git 项目配置免密认证。以下是详细步骤：

### 方法一：使用 Personal Access Token（推荐）

#### 步骤 1：在 GitLab 生成 Personal Access Token

1. 登录 GitLab
2. 点击右上角头像 → **Preferences**（偏好设置）
3. 左侧菜单选择 **Access Tokens**（访问令牌）
4. 填写信息：
   - **Token name**：填写一个描述性名称，如 `windows-auto-sync`
   - **Expiration date**：设置过期日期（建议设置较长时间或留空表示永不过期）
   - **Select scopes**：勾选以下权限
     - ✅ `read_repository`（读取仓库）
     - ✅ `write_repository`（写入仓库，如需 push）
5. 点击 **Create personal access token**
6. **⚠️ 重要：立即复制并保存生成的 Token，它只显示一次！**

#### 步骤 2：在 Git 项目中配置 Token

打开 PowerShell，进入你的 Git 项目目录，执行以下命令：

```powershell
# 进入项目目录
cd "F:\workspace\git_workspace\mc-shop-app\shop-app"

# 查看当前远程仓库地址
git remote -v

# 设置带 Token 的远程仓库地址
# 格式：https://用户名:Token@gitlab.com/用户名/仓库名.git
git remote set-url origin https://your-username:glpat-xxxxxxxxxxxx@gitlab.example.com/group/project.git
```

**URL 格式说明：**
```
https://用户名:Token@GitLab域名/组织或用户/仓库名.git
```

**示例：**
```powershell
# 假设：
# - GitLab 用户名：zhangsan
# - Token：glpat-abc123xyz789
# - GitLab 地址：gitlab.mycompany.com
# - 项目路径：frontend/mc-shop-app

git remote set-url origin https://zhangsan:glpat-abc123xyz789@gitlab.mycompany.com/frontend/mc-shop-app.git
```

#### 步骤 3：验证配置

```powershell
# 测试拉取（应该不再提示输入密码）
git fetch origin

# 如果成功，会显示类似以下内容或无输出（表示已是最新）
# From https://gitlab.mycompany.com/frontend/mc-shop-app
#  * branch            test       -> FETCH_HEAD
```

---

### 方法二：使用 Git Credential Manager（Windows 凭据管理器）

如果你不想在 URL 中暴露 Token，可以使用 Windows 凭据管理器：

#### 步骤 1：确保 Git Credential Manager 已安装

```powershell
# 检查是否已配置
git config --global credential.helper

# 如果输出为空，设置为 manager-core
git config --global credential.helper manager-core
```

#### 步骤 2：存储凭据

```powershell
# 进入项目目录
cd "F:\workspace\git_workspace\mc-shop-app\shop-app"

# 执行一次 git fetch，系统会弹出凭据输入窗口
git fetch origin

# 在弹出的窗口中：
# - 用户名：填写你的 GitLab 用户名
# - 密码：填写你的 Personal Access Token（不是密码！）
# - 勾选"记住我的凭据"
```

#### 步骤 3：验证凭据已保存

1. 打开 **控制面板** → **用户账户** → **凭据管理器**
2. 选择 **Windows 凭据**
3. 找到类似 `git:https://gitlab.mycompany.com` 的条目
4. 确认凭据已保存

---

### 方法三：使用 SSH 密钥（可选）

如果你更喜欢使用 SSH：

#### 步骤 1：生成 SSH 密钥

```powershell
# 生成 SSH 密钥
ssh-keygen -t ed25519 -C "your-email@example.com"

# 按提示操作，可以设置密码或留空（留空则免密）
```

#### 步骤 2：添加公钥到 GitLab

1. 查看公钥：
   ```powershell
   cat ~/.ssh/id_ed25519.pub
   ```
2. 复制输出的公钥内容
3. 登录 GitLab → **Preferences** → **SSH Keys**
4. 粘贴公钥并保存

#### 步骤 3：修改远程仓库地址为 SSH 格式

```powershell
# 进入项目目录
cd "F:\workspace\git_workspace\mc-shop-app\shop-app"

# 修改为 SSH 地址
git remote set-url origin git@gitlab.mycompany.com:frontend/mc-shop-app.git

# 测试连接
ssh -T git@gitlab.mycompany.com
```

---

## 完整配置流程示例

假设你要配置一个新项目 `my-new-app`：

### 1. 克隆项目

```powershell
cd F:\workspace\git_workspace
git clone https://gitlab.mycompany.com/frontend/my-new-app.git
```

### 2. 配置免密认证

```powershell
cd F:\workspace\git_workspace\my-new-app

# 使用 Token 方式
git remote set-url origin https://zhangsan:glpat-abc123xyz789@gitlab.mycompany.com/frontend/my-new-app.git

# 验证
git fetch origin
```

### 3. 添加到配置文件

编辑 `projects-config.json`：

```json
{
    "description": "Multi-project sync configuration",
    "projects": [
        {
            "name": "my-new-app",
            "enabled": true,
            "projectDir": "F:\\workspace\\git_workspace\\my-new-app",
            "targetDir": "F:\\workspace\\delivery\\my-new-app-output",
            "branch": "test"
        }
    ]
}
```

### 4. 测试同步

```powershell
# 测试单个项目
.\multi-project-sync.ps1 -ProjectName "my-new-app"

# 或测试所有项目
.\multi-project-sync.ps1
```

### 5. 创建计划任务（可选）

```powershell
# 以管理员身份运行 PowerShell
.\setup-multi-task.ps1 -TaskAction create
```

---

## 常见问题

### Q1: 执行脚本时提示"无法加载文件，因为在此系统上禁止运行脚本"

**解决方案：** 以管理员身份运行 PowerShell，执行：
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### Q2: Git fetch/pull 时仍然提示输入密码

**可能原因：**
- Token 配置不正确
- Token 已过期
- URL 格式错误

**解决方案：** 重新检查并设置远程 URL：
```powershell
git remote -v  # 查看当前配置
git remote set-url origin https://用户名:Token@gitlab地址/项目路径.git
```

### Q3: 计划任务不执行

**检查步骤：**
1. 确保以管理员身份创建任务
2. 查看任务状态：`.\setup-multi-task.ps1 -TaskAction status`
3. 检查 Windows 事件查看器中的任务计划程序日志

### Q4: npm install 失败

**可能原因：**
- Node.js 未安装或未添加到 PATH
- 网络问题
- 依赖冲突

**解决方案：**
1. 确认 Node.js 已安装：`node -v`
2. 检查 npm 配置：`npm config list`
3. 尝试清理缓存：`npm cache clean --force`

---

## 日志文件

| 日志文件 | 说明 | 最大大小 |
|----------|------|----------|
| `build.log` | 单项目构建日志 | 10MB（自动轮转，保留5个备份） |
| `multi-sync.log` | 多项目同步日志 | 10MB（自动轮转） |

---

## 版本要求

- **PowerShell**: 5.1 或更高版本
- **Windows**: Windows 10 / Windows Server 2016 或更高版本
- **Node.js**: 根据项目要求
- **Git**: 2.x 或更高版本

